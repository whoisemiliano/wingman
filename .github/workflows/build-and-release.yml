name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        default: 'v0.1.0'

env:
  PYTHON_VERSION: '3.11'

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            executable_name: wingman
          - os: windows-latest
            platform: windows
            executable_name: wingman.exe
          - os: macos-latest
            platform: macos
            executable_name: wingman

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Install Wingman
      run: pip install -e .

    - name: Test installation
      run: python test_installation.py

    - name: Build executable
      run: |
        pyinstaller --clean --onefile \
          --name wingman \
          --add-data "README.md:." \
          --add-data "QUICKSTART.md:." \
          --hidden-import wingman \
          --hidden-import wingman.cli \
          --hidden-import wingman.commands \
          --hidden-import wingman.commands.field_extractor \
          --hidden-import wingman.commands.report_replacer \
          --hidden-import wingman.utils \
          --hidden-import wingman.utils.salesforce_client \
          --hidden-import click \
          --hidden-import rich \
          --hidden-import simple_salesforce \
          --hidden-import pandas \
          --hidden-import yaml \
          --hidden-import requests \
          wingman/cli.py

    - name: Test executable
      run: |
        if [ "${{ matrix.platform }}" = "windows" ]; then
          ./dist/wingman.exe --version
          ./dist/wingman.exe --help
        else
          ./dist/wingman --version
          ./dist/wingman --help
        fi

    - name: Create distribution package
      run: |
        mkdir -p dist-package
        cp dist/${{ matrix.executable_name }} dist-package/
        cp README.md QUICKSTART.md dist-package/
        
        # Create installation script
        if [ "${{ matrix.platform }}" = "windows" ]; then
          cat > dist-package/install.bat << 'EOF'
        @echo off
        echo Installing Wingman...
        echo.
        echo Wingman installed! Run: wingman.exe --help
        echo.
        echo Next steps:
        echo 1. Install Salesforce CLI: npm install -g @salesforce/cli
        echo 2. Authenticate: sf org login web
        echo 3. Test connection: wingman.exe test-connection --org ^<your-org^>
        pause
        EOF
        else
          cat > dist-package/install.sh << 'EOF'
        #!/bin/bash
        echo "Installing Wingman..."
        chmod +x wingman
        echo "Wingman installed! Run: ./wingman --help"
        echo ""
        echo "Next steps:"
        echo "1. Install Salesforce CLI: npm install -g @salesforce/cli"
        echo "2. Authenticate: sf org login web"
        echo "3. Test connection: ./wingman test-connection --org <your-org>"
        EOF
          chmod +x dist-package/install.sh
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wingman-${{ matrix.platform }}
        path: dist-package/
        retention-days: 30

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Create release assets
      run: |
        mkdir -p release-assets
        
        # Create platform-specific packages
        for platform in linux windows macos; do
          if [ -d "artifacts/wingman-$platform" ]; then
            cd "artifacts/wingman-$platform"
            if [ "$platform" = "windows" ]; then
              zip -r "../../release-assets/wingman-$platform.zip" .
            else
              tar -czf "../../release-assets/wingman-$platform.tar.gz" .
            fi
            cd ../..
          fi
        done
        
        # Create universal installer script
        cat > release-assets/install.sh << 'EOF'
        #!/bin/bash
        # Wingman Universal Installer
        
        set -e
        
        # Colors
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m'
        
        print_status() {
            echo -e "${BLUE}[INFO]${NC} $1"
        }
        
        print_success() {
            echo -e "${GREEN}[SUCCESS]${NC} $1"
        }
        
        print_error() {
            echo -e "${RED}[ERROR]${NC} $1"
        }
        
        print_status "Wingman Universal Installer"
        print_status "================================="
        
        # Detect OS
        if [[ "$OSTYPE" == "darwin"* ]]; then
            PLATFORM="macos"
        elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
            PLATFORM="linux"
        elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
            PLATFORM="windows"
        else
            print_error "Unsupported operating system: $OSTYPE"
            exit 1
        fi
        
        print_status "Detected platform: $PLATFORM"
        
        # Download appropriate package
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        if [ "$PLATFORM" = "windows" ]; then
            PACKAGE="wingman-windows.zip"
            EXECUTABLE="wingman.exe"
        else
            PACKAGE="wingman-$PLATFORM.tar.gz"
            EXECUTABLE="wingman"
        fi
        
        print_status "Downloading Wingman $VERSION for $PLATFORM..."
        
        # Create installation directory
        INSTALL_DIR="$HOME/.local/bin/wingman"
        mkdir -p "$INSTALL_DIR"
        cd "$INSTALL_DIR"
        
        # Download and extract
        curl -L -o "$PACKAGE" "https://github.com/whoisemiliano/wingman/releases/download/$VERSION/$PACKAGE"
        
        if [ "$PLATFORM" = "windows" ]; then
            unzip -o "$PACKAGE"
        else
            tar -xzf "$PACKAGE"
        fi
        
        # Make executable
        chmod +x "$EXECUTABLE"
        
        # Create symlink in PATH
        if [ "$PLATFORM" != "windows" ]; then
            mkdir -p "$HOME/.local/bin"
            ln -sf "$INSTALL_DIR/$EXECUTABLE" "$HOME/.local/bin/wingman"
        fi
        
        # Clean up
        rm "$PACKAGE"
        
        print_success "Wingman installed successfully!"
        print_status "Location: $INSTALL_DIR"
        
        if [ "$PLATFORM" != "windows" ]; then
            print_status "Added to PATH: ~/.local/bin/wingman"
        fi
        
        print_status ""
        print_status "Next steps:"
        print_status "1. Install Salesforce CLI: npm install -g @salesforce/cli"
        print_status "2. Authenticate: sf org login web"
        print_status "3. Test connection: wingman test-connection --org <your-org>"
        print_status "4. Get help: wingman --help"
        EOF
        
        chmod +x release-assets/install.sh

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: Wingman ${{ steps.get_version.outputs.VERSION }}
        body: |
          # Wingman ${{ steps.get_version.outputs.VERSION }}
          
          A powerful CLI tool for Salesforce field management and report operations.
          
          ## Downloads
          
          ### Quick Install (Recommended)
          ```bash
          curl -sSL https://raw.githubusercontent.com/whoisemiliano/wingman/${{ steps.get_version.outputs.VERSION }}/install.sh | bash
          ```
          
          ### Manual Downloads
          - **macOS**: [wingman-macos.tar.gz](https://github.com/whoisemiliano/wingman/releases/download/${{ steps.get_version.outputs.VERSION }}/wingman-macos.tar.gz)
          - **Linux**: [wingman-linux.tar.gz](https://github.com/${{ steps.get_version.outputs.VERSION }}/wingman-linux.tar.gz)
          - **Windows**: [wingman-windows.zip](https://github.com/${{ steps.get_version.outputs.VERSION }}/wingman-windows.zip)
          
          ## What's New
          
          - Initial release with field metadata extraction
          - Report field replacement functionality
          - Cross-platform standalone executables
          - Rich CLI interface with progress bars
          
          ## Quick Start
          
          1. Download and install for your platform
          2. Install Salesforce CLI: `npm install -g @salesforce/cli`
          3. Authenticate: `sf org login web`
          4. Test connection: `wingman test-connection --org <your-org>`
          5. Extract fields: `wingman extract-fields --org <your-org> --objects Account`
          
          ## Documentation
          
          - [README](https://github.com/whoisemiliano/wingman/blob/${{ steps.get_version.outputs.VERSION }}/README.md)
          - [Quick Start Guide](https://github.com/whoisemiliano/wingman/blob/${{ steps.get_version.outputs.VERSION }}/QUICKSTART.md)
          
          ## Support
          
          - [Issues](https://github.com/whoisemiliano/wingman/issues)
          - [Discussions](https://github.com/whoisemiliano/wingman/discussions)
        files: |
          release-assets/*
        draft: false
        prerelease: false

  manual-release:
    name: Manual Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from input
      id: get_version
      run: echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Create release assets
      run: |
        mkdir -p release-assets
        
        # Create platform-specific packages
        for platform in linux windows macos; do
          if [ -d "artifacts/wingman-$platform" ]; then
            cd "artifacts/wingman-$platform"
            if [ "$platform" = "windows" ]; then
              zip -r "../../release-assets/wingman-$platform.zip" .
            else
              tar -czf "../../release-assets/wingman-$platform.tar.gz" .
            fi
            cd ../..
          fi
        done

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: Wingman ${{ steps.get_version.outputs.VERSION }}
        body: |
          # Wingman ${{ steps.get_version.outputs.VERSION }}
          
          Manual release created via GitHub Actions.
          
          ## Downloads
          - **macOS**: [wingman-macos.tar.gz](https://github.com/whoisemiliano/wingman/releases/download/${{ steps.get_version.outputs.VERSION }}/wingman-macos.tar.gz)
          - **Linux**: [wingman-linux.tar.gz](https://github.com/whoisemiliano/wingman/releases/download/${{ steps.get_version.outputs.VERSION }}/wingman-linux.tar.gz)
          - **Windows**: [wingman-windows.zip](https://github.com/whoisemiliano/wingman/releases/download/${{ steps.get_version.outputs.VERSION }}/wingman-windows.zip)
        files: |
          release-assets/*
        draft: true
        prerelease: false
